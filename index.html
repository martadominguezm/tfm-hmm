<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <title>SL</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Bootstrap icons-->
        <!--- BOOTSTRAP --->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" 
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" 
        crossorigin="anonymous">
        <link href="css/styles.css" rel="stylesheet" />
        <script src="https://www.gstatic.com/firebasejs/7.23.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.23.0/firebase-database.js"></script>

    </head>
    <body>
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container px-4 px-lg-5">
            <a class="navbar-brand" href="index.html">Sportland</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
              <!-- SignIn y SignUp-->
              <li class="nav-item logged-out" style="display: none;">
                <a id ="botonSignIn" type= "button" class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#signinModal">SigIn</a>
              </li>
              <li class="nav-item logged-out" style="display: none;">
                <a type= "button" class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#signupModal">SignUp</a>
              </li>

              <!-- Tienda/Deportes, Favoritos y Noticias-->
              <li class="nav-item logged-in dropdown">
                <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Tienda</a>
                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                    <li><a id="btn-deportes" class="dropdown-item" href="deportes.html">Deportes</a></li>
                
                </ul>
             </li>
             <li class="nav-item logged-in"><a id="btn-favoritos" class="nav-link active" aria-current="page" href="favoritos.hmtl">Favoritos</a></li>
              <li class="nav-item logged-in"><a id="btn-noticias" class="nav-link active" aria-current="page" href="noticias.html">Noticias</a></li>
            
              <!-- LogOut-->
              <li class="nav-item logged-in" style="display: none;">
                <a class="nav-link" href="#" id ="logout">LogOut</a>
              </li>
            </ul>
            <!-- Carrito-->
            <form class="nav-item logged-in">
              <a id="btn-carrito" class="nav-link active my-2 my-lg-0" aria-current="page" href="carrito.html">Carrito</a>
            </form>
          </div>
        </div>
      </nav>
<div id="viewContainer">
        <!-- Header-->
        <header class="bg-dark py-2">
            <div class="container px-4 px-lg-5 my-5">
                <div class="text-center text-white">
                    <h1 class="display-8 fw-bolder">¡Bienvenido a SportLand!</h1>
                </div>
            </div>
        </header>
        <!-- Section-->

      <!--MAIN CONTENT-->
      <div class="container p-4">
        <div class="row">
            <div class="col-md-6 offset-md-3">
                
                <ul class = "list-group sesiones"> </ul>
            </div>
        </div>

      </div>







<!-- Modal SignUP-->
<div class="modal fade" id="signupModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Únete a nosotros</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id = "signup-form">
                        
              <div class="form-group">
                <input type = "text" id="signup-nombre" class = "form-control" placeholder="Nombre" required>
              </div>          
              <div class="form-group">
                  <input type = "text" id="signup-apellidos" class = "form-control" placeholder="Apellidos" required>
              </div>
              <div class="form-group">
                  <input type = "text" id="signup-email" class = "form-control" placeholder="Email" required>
              </div>
              <div class="form-group">
                  <input type = "password" id="signup-password" class = "form-control" placeholder="Password" required>
              </div>
         
              <button type="submit" class="btn btn-primary">SignUp</button>
        </form>
      </div>

    </div>
  </div>
</div>

  <!-- Modal SigIN-->
  <div class="modal fade" id="signinModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Accede a SportLand</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id = "login-form">
                  <div class="form-group">
                      <input type = "text" id="login-email" class = "form-control" placeholder="Email" required>
                  </div>
                  <div class="form-group">
                      <input type = "password" id="login-password" class = "form-control" placeholder="Password" required>
                  </div>
             
                  <button type="submit" class="btn btn-primary">SignIn</button>
            </form>
          </div>
  
        </div>
      </div>
    </div>
  </div>
      <!-- Bootstrap core JS-->
      <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
     

     
      

      <!-- Resetear los formularios de SignIn y SignUp-->
<!--       <script type="text/javascript">
        $(document).ready(function() {
            $('#signinModal').click(function() {
                $('.login-email').val('');
                $('.login-password').val('');
            });
        });
      </script>
      <script type="text/javascript">
      $(document).ready(function() {
          $('#signupModal').click(function() {
              $('.signup-email').val('');
              $('.signup-password').val('');
          });
      });
      </script> -->

      <!--- FIREBASE-->
      
      <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        //import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
        //import { getAuth, createUserWithEmailAndPassword  } from "firebase/auth";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection,getDocs  } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getDatabase, ref, child, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        //import { getAnalytics, logEvent  } from "firebase/analytics";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
      
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyCBac8p_wMjkq6IRukGb6x0mdwo73rU0OQ",
          authDomain: "fb-hmm-auth.firebaseapp.com",
          projectId: "fb-hmm-auth",
          storageBucket: "fb-hmm-auth.appspot.com",
          messagingSenderId: "388109074621",
          appId: "1:388109074621:web:fe0e857f911aac365637d4",
          measurementId: "G-MKKWN3S36J"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        // Get analytics
        //const analytics = getAnalytics(app);
        // Initialize Firebase Authentication and get a reference to the service
        const auth = getAuth();
        const user = auth.currentUser;
        
          // Initialize Cloud Firestore and get a reference to the service
        const fs = getFirestore(app);

        // Get a reference to the Real-time Database
        const database = getDatabase();


        //Creamos una referencia de los botones del navbar que queremos que se muestren en cada caso
        const loggedOutLinks = document.querySelectorAll('.logged-out')
        const loggedInLinks = document.querySelectorAll('.logged-in')

        const loginCheck = (user) =>{
            if(user){
                loggedInLinks.forEach(link => link.style.display = 'block');
                loggedOutLinks.forEach(link => link.style.display = 'none');
            }else{
                loggedInLinks.forEach(link => link.style.display = 'none');
                loggedOutLinks.forEach(link => link.style.display = 'block');

            }
        } 

        //SIGN UP
        const signupForm = document.querySelector('#signup-form');
      
        signupForm.addEventListener('submit', (e) =>{
            e.preventDefault();

            const email = document.querySelector('#signup-email').value;
            const password = document.querySelector('#signup-password').value;

            //se lo damos a firebase para que capture los datos
            createUserWithEmailAndPassword(auth, email,password)
                .then(userCredential => {
                  //clear the form
                  signupForm.reset();
                  //Cerramos ventana modal del SignUp al inciar sesión
                  $('#signupModal').modal('hide')

                })
        });

        //SIGN IN
        const signinForm = document.querySelector('#login-form');

        signinForm.addEventListener('submit', e =>{
            e.preventDefault();

            const email = document.querySelector('#login-email').value;
            const password = document.querySelector('#login-password').value;
            
          signInWithEmailAndPassword(auth, email,password)
              .then(userCredential => {
                  //clear the form
                  const user = userCredential.user;
                  signinForm.reset();
                  console.log('sign in')
                
                  //Cerramos ventana modal del SignIn al inciar sesión
                  $('#signinModal').modal('hide')
              })
          });

        //LOG OUT
        const logout = document.querySelector('#logout');

        logout.addEventListener('click', (e) =>{
            e.preventDefault();
            
            signOut(auth).then(()=>{
                console.log('sign out')
            })
        });

        //Acceso a las colecciones del Firestore Database
        const sesionesList = document.querySelector('.sesiones');
        const setupSesiones = (data) => {
            if(data.length) {
                let html = '';
                data.forEach(doc =>{
                  
                    const sesion = doc.data()
                    const li = `
                    <li class = "list-group-item list-group-item-action"> 
                        <h5>${sesion.id_user}</h5>
                        <p>${sesion.id_session}</p>
                        <p>${sesion.url}</p>
                  
                    </li>
                    `;
                    html += li;

                });
                //Aquí se muestra el contenido si estás logueado
                sesionesList.innerHTML = html;
                
            }else{
                //Aquí se muestra el contenido cuando no estás logueado
                sesionesList.innerHTML ='<p class = "text-center">Logueate para disfrutar de la web.</p>';
            }
        }

             
      //AJAX Request para coger el código del resto de ficheros html e ir navegando por la web
        // NO VA
        const viewContainer = document.getElementById("viewContainer");

        function showView(viewName) {
          const xhr = new XMLHttpRequest();
          xhr.open("GET", `${viewName}`, true);
          xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
              viewContainer.innerHTML = xhr.responseText;
            }
          };
          xhr.send();
        }



        //NO VA
        // GUARDAR NAVEGACIÓN
        function saveNavigationInfo(uid) {
          viewContainer.addEventListener("click", function() {
            // Show the sign-in view when the page loads
            //showView(window.location.href);
            var currentURL = window.location.href;
            console.log("Estoy navegando en:" + currentURL)
            // Get a reference to the Real-time Database
            const db = 'https://fb-hmm-auth-default-rtdb.europe-west1.firebasedatabase.app/'
            push(ref(db, 'users/' + uid + '/navigation/'), { //me gustaría poder generar un id de sesión cada vez que se loguea y navega
              url: currentURL
            });
            console.log("Me guarda la navegación?¿?¿?¿")
          });
        }

        
        //Eventos 
        //este evento se dispara cuando un usuario se loguea o hace logout por ejemplo
        onAuthStateChanged(auth, (user)=>{
            if (user) {
                // se guarda información sobre el usuario en el almacenamiento local
                localStorage.setItem("user", JSON.stringify(user));
                //Cogemos el UID asociado al usuario
                const userID = user.uid;
                console.log("Hola: " + user.email)
                console.log("Este es su UID: " + userID)

                //lamo a la funcion que guarda la navegación
                saveNavigationInfo(userID);


                getDocs(collection(fs, 'sesiones'))
                .then(snapshot =>{
                    // Llamamos a la funcion setupSesiones que muestra el contenido que queramos cuando un usuario está logueado
                    setupSesiones(snapshot.docs)
                    //Llamamos a loginCheck que muestra los iconos del NavBar correspondientes
                    loginCheck(user);
                })
            }else{
                //console.log('auth: sign out')
                localStorage.removeItem("user");
                setupSesiones([]);
                loginCheck(user);

            }
        });

        //TRANSICIÓN ENTRE PÁGINAS HTML
        document.getElementById("btn-deportes").addEventListener("click", function() {
          window.location.href = "deportes.html"
          // Show the sign-in view when the page loads
          showView(window.location.href);
          console.log("Estoy navegando en 2.0: " + window.location.href)
          console.log('El usuario logueado accede a deportes');

        });
        document.getElementById("btn-favoritos").addEventListener("click", function() {
          window.location.href = "favoritos.html";
        });
        document.getElementById("btn-noticias").addEventListener("click", function() {
          window.location.href = "noticias.html";
        });
        document.getElementById("btn-carrito").addEventListener("click", function() {
          window.location.href = "carrito.html";
        }); 

      </script>
         
  



</body>

</html>


